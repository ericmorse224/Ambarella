'use strict'

const vendors = require('./vendors.json')

const env = process.env

// Used for testing only
Object.defineProperty(exports, '_vendors', {
  value: vendors.map(function (v) {
    return v.constant
  ***REMOVED***)
***REMOVED***)

exports.name = null
exports.isPR = null

vendors.forEach(function (vendor) {
  const envs = Array.isArray(vendor.env) ? vendor.env : [vendor.env]
  const isCI = envs.every(function (obj) {
    return checkEnv(obj)
  ***REMOVED***)

  exports[vendor.constant] = isCI

  if (!isCI) {
    return
  ***REMOVED***

  exports.name = vendor.name

  switch (typeof vendor.pr) {
    case 'string':
      // "pr": "CIRRUS_PR"
      exports.isPR = !!env[vendor.pr]
      break
    case 'object':
      if ('env' in vendor.pr) {
        // "pr": { "env": "BUILDKITE_PULL_REQUEST", "ne": "false" ***REMOVED***
        exports.isPR = vendor.pr.env in env && env[vendor.pr.env] !== vendor.pr.ne
      ***REMOVED*** else if ('any' in vendor.pr) {
        // "pr": { "any": ["ghprbPullId", "CHANGE_ID"] ***REMOVED***
        exports.isPR = vendor.pr.any.some(function (key) {
          return !!env[key]
        ***REMOVED***)
      ***REMOVED*** else {
        // "pr": { "DRONE_BUILD_EVENT": "pull_request" ***REMOVED***
        exports.isPR = checkEnv(vendor.pr)
      ***REMOVED***
      break
    default:
      // PR detection not supported for this vendor
      exports.isPR = null
  ***REMOVED***
***REMOVED***)

exports.isCI = !!(
  env.CI !== 'false' && // Bypass all checks if CI env is explicitly set to 'false'
  (env.BUILD_ID || // Jenkins, Cloudbees
  env.BUILD_NUMBER || // Jenkins, TeamCity
  env.CI || // Travis CI, CircleCI, Cirrus CI, Gitlab CI, Appveyor, CodeShip, dsari
  env.CI_APP_ID || // Appflow
  env.CI_BUILD_ID || // Appflow
  env.CI_BUILD_NUMBER || // Appflow
  env.CI_NAME || // Codeship and others
  env.CONTINUOUS_INTEGRATION || // Travis CI, Cirrus CI
  env.RUN_ID || // TaskCluster, dsari
  exports.name ||
  false)
)

function checkEnv (obj) {
  // "env": "CIRRUS"
  if (typeof obj === 'string') return !!env[obj]

  // "env": { "env": "NODE", "includes": "/app/.heroku/node/bin/node" ***REMOVED***
  if ('env' in obj) {
    // Currently there are no other types, uncomment when there are
    // if ('includes' in obj) {
    return env[obj.env] && env[obj.env].includes(obj.includes)
    // ***REMOVED***
  ***REMOVED***
  if ('any' in obj) {
    return obj.any.some(function (k) {
      return !!env[k]
    ***REMOVED***)
  ***REMOVED***
  return Object.keys(obj).every(function (k) {
    return env[k] === obj[k]
  ***REMOVED***)
***REMOVED***
