/**
 * @param {object***REMOVED*** exports
 * @param {Set<string>***REMOVED*** keys
 */
function loop(exports, keys) {
	if (typeof exports === 'string') {
		return exports;
	***REMOVED***

	if (exports) {
		let idx, tmp;
		if (Array.isArray(exports)) {
			for (idx=0; idx < exports.length; idx++) {
				if (tmp = loop(exports[idx], keys)) return tmp;
			***REMOVED***
		***REMOVED*** else {
			for (idx in exports) {
				if (keys.has(idx)) {
					return loop(exports[idx], keys);
				***REMOVED***
			***REMOVED***
		***REMOVED***
	***REMOVED***
***REMOVED***

/**
 * @param {string***REMOVED*** name The package name
 * @param {string***REMOVED*** entry The target entry, eg "."
 * @param {number***REMOVED*** [condition] Unmatched condition?
 */
function bail(name, entry, condition) {
	throw new Error(
		condition
		? `No known conditions for "${entry***REMOVED***" entry in "${name***REMOVED***" package`
		: `Missing "${entry***REMOVED***" export in "${name***REMOVED***" package`
	);
***REMOVED***

/**
 * @param {string***REMOVED*** name the package name
 * @param {string***REMOVED*** entry the target path/import
 */
function toName(name, entry) {
	return entry === name ? '.'
		: entry[0] === '.' ? entry
		: entry.replace(new RegExp('^' + name + '\/'), './');
***REMOVED***

/**
 * @param {object***REMOVED*** pkg package.json contents
 * @param {string***REMOVED*** [entry] entry name or import path
 * @param {object***REMOVED*** [options]
 * @param {boolean***REMOVED*** [options.browser]
 * @param {boolean***REMOVED*** [options.require]
 * @param {string[]***REMOVED*** [options.conditions]
 * @param {boolean***REMOVED*** [options.unsafe]
 */
export function resolve(pkg, entry='.', options={***REMOVED***) {
	let { name, exports ***REMOVED*** = pkg;

	if (exports) {
		let { browser, require, unsafe, conditions=[] ***REMOVED*** = options;

		let target = toName(name, entry);
		if (target !== '.' && !target.startsWith('./')) {
			target = './' + target; // ".ini" => "./.ini"
		***REMOVED***

		if (typeof exports === 'string') {
			return target === '.' ? exports : bail(name, target);
		***REMOVED***

		let allows = new Set(['default', ...conditions]);
		unsafe || allows.add(require ? 'require' : 'import');
		unsafe || allows.add(browser ? 'browser' : 'node');

		let key, m, k, kv, tmp, isSingle=false;

		for (key in exports) {
			isSingle = key[0] !== '.';
			break;
		***REMOVED***

		if (isSingle) {
			return target === '.'
				? loop(exports, allows) || bail(name, target, 1)
				: bail(name, target);
		***REMOVED***

		if (tmp = exports[target]) {
			return loop(tmp, allows) || bail(name, target, 1);
		***REMOVED***

		if (target !== '.') {
			for (key in exports) {
				if (k && key.length < k.length) {
					// do not allow "./" to match if already matched "./foo*" key
				***REMOVED*** else if (key[key.length - 1] === '/' && target.startsWith(key)) {
					kv = target.substring(key.length);
					k = key;
				***REMOVED*** else {
					tmp = key.indexOf('*', 2);
					if (!!~tmp) {
						m = RegExp(
							'^\.\/' + key.substring(2, tmp) + '(.*)' + key.substring(1+tmp)
						).exec(target);

						if (m && m[1]) {
							kv = m[1];
							k = key;
						***REMOVED***
					***REMOVED***
				***REMOVED***
			***REMOVED***

			if (k && kv) {
				// must have value
				tmp = loop(exports[k], allows);
				if (!tmp) return bail(name, target);

				return tmp.includes('*')
					? tmp.replace(/[*]/g, kv)
					: tmp + kv;
			***REMOVED***
		***REMOVED***

		return bail(name, target);
	***REMOVED***
***REMOVED***

/**
 * @param {object***REMOVED*** pkg
 * @param {object***REMOVED*** [options]
 * @param {string|boolean***REMOVED*** [options.browser]
 * @param {string[]***REMOVED*** [options.fields]
 */
export function legacy(pkg, options={***REMOVED***) {
	let i=0, value,
		browser = options.browser,
		fields = options.fields || ['module', 'main'];

	if (browser && !fields.includes('browser')) {
		fields.unshift('browser');
	***REMOVED***

	for (; i < fields.length; i++) {
		if (value = pkg[fields[i]]) {
			if (typeof value == 'string') {
				//
			***REMOVED*** else if (typeof value == 'object' && fields[i] == 'browser') {
				if (typeof browser == 'string') {
					value = value[browser=toName(pkg.name, browser)];
					if (value == null) return browser;
				***REMOVED***
			***REMOVED*** else {
				continue;
			***REMOVED***

			return typeof value == 'string'
				? ('./' + value.replace(/^\.?\//, ''))
				: value;
		***REMOVED***
	***REMOVED***
***REMOVED***
