var fs = require('fs');
var path = require('path');
var pify = require('pify');

var stat = pify(fs.stat);
var readFile = pify(fs.readFile);
var resolve = path.resolve;

var cache = Object.create(null);

function convert(content, encoding) {
	if (Buffer.isEncoding(encoding)) {
		return content.toString(encoding);
	***REMOVED***
	return content;
***REMOVED***

module.exports = function (path, encoding) {
	path = resolve(path);

	return stat(path).then(function (stats) {
		var item = cache[path];

		if (item && item.mtime.getTime() === stats.mtime.getTime()) {
			return convert(item.content, encoding);
		***REMOVED***

		return readFile(path).then(function (data) {
			cache[path] = {
				mtime: stats.mtime,
				content: data
			***REMOVED***;

			return convert(data, encoding);
		***REMOVED***);
	***REMOVED***).catch(function (err) {
		cache[path] = null;
		return Promise.reject(err);
	***REMOVED***);
***REMOVED***;

module.exports.sync = function (path, encoding) {
	path = resolve(path);

	try {
		var stats = fs.statSync(path);
		var item = cache[path];

		if (item && item.mtime.getTime() === stats.mtime.getTime()) {
			return convert(item.content, encoding);
		***REMOVED***

		var data = fs.readFileSync(path);

		cache[path] = {
			mtime: stats.mtime,
			content: data
		***REMOVED***;

		return convert(data, encoding);
	***REMOVED*** catch (err) {
		cache[path] = null;
		throw err;
	***REMOVED***

***REMOVED***;

module.exports.get = function (path, encoding) {
	path = resolve(path);
	if (cache[path]) {
		return convert(cache[path].content, encoding);
	***REMOVED***
	return null;
***REMOVED***;

module.exports.clear = function () {
	cache = Object.create(null);
***REMOVED***;
