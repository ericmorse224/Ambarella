'use strict'

const assert = require('chai').assert
const proxyquire = require('proxyquire')
const spooks = require('spooks')
const Promise = require('bluebird')

const modulePath = '../../src/stringify'

suite('stringify:', () => {
  test('require does not throw', () => {
    assert.doesNotThrow(() => {
      require(modulePath)
    ***REMOVED***)
  ***REMOVED***)

  test('require returns function', () => {
    assert.isFunction(require(modulePath))
  ***REMOVED***)

  suite('require:', () => {
    let log, stringify

    setup(() => {
      log = {***REMOVED***

      stringify = proxyquire(modulePath, {
        './streamify': spooks.fn({
          name: 'streamify',
          log: log,
          results: [
            { on: spooks.fn({ name: 'on', log: log ***REMOVED***) ***REMOVED***
          ]
        ***REMOVED***)
      ***REMOVED***)
    ***REMOVED***)

    test('stringify expects two arguments', () => {
      assert.lengthOf(stringify, 2)
    ***REMOVED***)

    test('stringify does not throw', () => {
      assert.doesNotThrow(() => {
        stringify()
      ***REMOVED***)
    ***REMOVED***)

    test('stringify returns promise', () => {
      assert.instanceOf(stringify(), Promise)
    ***REMOVED***)

    test('streamify was not called', () => {
      assert.strictEqual(log.counts.streamify, 0)
    ***REMOVED***)

    suite('stringify:', () => {
      let data, options, resolved, rejected, result, done

      setup(() => {
        data = {***REMOVED***
        options = {***REMOVED***
        stringify(data, options)
          .then(res => {
            resolved = res
            done()
          ***REMOVED***)
          .catch(rej => {
            rejected = rej
            done()
          ***REMOVED***)
      ***REMOVED***)

      teardown(() => {
        resolved = rejected = undefined
      ***REMOVED***)

      test('streamify was called once', () => {
        assert.strictEqual(log.counts.streamify, 1)
        assert.isUndefined(log.these.streamify[0])
      ***REMOVED***)

      test('streamify was called correctly', () => {
        assert.lengthOf(log.args.streamify[0], 2)
        assert.strictEqual(log.args.streamify[0][0], data)
        assert.lengthOf(Object.keys(log.args.streamify[0][0]), 0)
        assert.strictEqual(log.args.streamify[0][1], options)
        assert.lengthOf(Object.keys(log.args.streamify[0][1]), 0)
      ***REMOVED***)

      test('stream.on was called four times', () => {
        assert.strictEqual(log.counts.on, 4)
      ***REMOVED***)

      test('stream.on was called correctly first time', () => {
        assert.lengthOf(log.args.on[0], 2)
        assert.strictEqual(log.args.on[0][0], 'data')
        assert.isFunction(log.args.on[0][1])
      ***REMOVED***)

      test('stream.on was called correctly second time', () => {
        assert.strictEqual(log.args.on[1][0], 'end')
        assert.isFunction(log.args.on[1][1])
        assert.notStrictEqual(log.args.on[1][1], log.args.on[0][1])
      ***REMOVED***)

      test('stream.on was called correctly third time', () => {
        assert.strictEqual(log.args.on[2][0], 'error')
        assert.isFunction(log.args.on[2][1])
        assert.notStrictEqual(log.args.on[2][1], log.args.on[0][1])
        assert.notStrictEqual(log.args.on[2][1], log.args.on[1][1])
      ***REMOVED***)

      test('stream.on was called correctly fourth time', () => {
        assert.strictEqual(log.args.on[3][0], 'dataError')
        assert.isFunction(log.args.on[3][1])
        assert.strictEqual(log.args.on[3][1], log.args.on[2][1])
      ***REMOVED***)

      test('promise is unfulfilled', () => {
        assert.isUndefined(resolved)
        assert.isUndefined(rejected)
      ***REMOVED***)

      suite('data event:', () => {
        setup(() => {
          log.args.on[0][1]('foo')
        ***REMOVED***)

        test('promise is unfulfilled', () => {
          assert.isUndefined(resolved)
          assert.isUndefined(rejected)
        ***REMOVED***)

        suite('end event:', () => {
          setup(d => {
            done = d
            log.args.on[1][1]()
          ***REMOVED***)

          test('promise is resolved', () => {
            assert.strictEqual(resolved, 'foo')
          ***REMOVED***)

          test('promise is not rejected', () => {
            assert.isUndefined(rejected)
          ***REMOVED***)
        ***REMOVED***)

        suite('data event:', () => {
          setup(() => {
            log.args.on[0][1]('bar')
          ***REMOVED***)

          test('promise is unfulfilled', () => {
            assert.isUndefined(resolved)
            assert.isUndefined(rejected)
          ***REMOVED***)

          suite('end event:', () => {
            setup(d => {
              done = d
              log.args.on[1][1]()
            ***REMOVED***)

            test('promise is resolved', () => {
              assert.strictEqual(resolved, 'foobar')
            ***REMOVED***)
          ***REMOVED***)

          suite('error event:', () => {
            setup(d => {
              done = d
              log.args.on[2][1]('wibble')
            ***REMOVED***)

            test('promise is rejected', () => {
              assert.strictEqual(rejected, 'wibble')
            ***REMOVED***)
          ***REMOVED***)

          suite('dataError event:', () => {
            setup(d => {
              done = d
              log.args.on[3][1]('wibble')
            ***REMOVED***)

            test('promise is rejected', () => {
              assert.strictEqual(rejected, 'wibble')
            ***REMOVED***)
          ***REMOVED***)
        ***REMOVED***)
      ***REMOVED***)
    ***REMOVED***)
  ***REMOVED***)
***REMOVED***)
