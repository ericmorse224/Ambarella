'use strict';

var GetIntrinsic = require('get-intrinsic');
var callBound = require('call-bound');
var inspect = require('object-inspect');

var $TypeError = require('es-errors/type');
var $Map = GetIntrinsic('%Map%', true);

/** @type {<K, V>(thisArg: Map<K, V>, key: K) => V***REMOVED*** */
var $mapGet = callBound('Map.prototype.get', true);
/** @type {<K, V>(thisArg: Map<K, V>, key: K, value: V) => void***REMOVED*** */
var $mapSet = callBound('Map.prototype.set', true);
/** @type {<K, V>(thisArg: Map<K, V>, key: K) => boolean***REMOVED*** */
var $mapHas = callBound('Map.prototype.has', true);
/** @type {<K, V>(thisArg: Map<K, V>, key: K) => boolean***REMOVED*** */
var $mapDelete = callBound('Map.prototype.delete', true);
/** @type {<K, V>(thisArg: Map<K, V>) => number***REMOVED*** */
var $mapSize = callBound('Map.prototype.size', true);

/** @type {import('.')***REMOVED*** */
module.exports = !!$Map && /** @type {Exclude<import('.'), false>***REMOVED*** */ function getSideChannelMap() {
	/** @typedef {ReturnType<typeof getSideChannelMap>***REMOVED*** Channel */
	/** @typedef {Parameters<Channel['get']>[0]***REMOVED*** K */
	/** @typedef {Parameters<Channel['set']>[1]***REMOVED*** V */

	/** @type {Map<K, V> | undefined***REMOVED*** */ var $m;

	/** @type {Channel***REMOVED*** */
	var channel = {
		assert: function (key) {
			if (!channel.has(key)) {
				throw new $TypeError('Side channel does not contain ' + inspect(key));
			***REMOVED***
		***REMOVED***,
		'delete': function (key) {
			if ($m) {
				var result = $mapDelete($m, key);
				if ($mapSize($m) === 0) {
					$m = void undefined;
				***REMOVED***
				return result;
			***REMOVED***
			return false;
		***REMOVED***,
		get: function (key) { // eslint-disable-line consistent-return
			if ($m) {
				return $mapGet($m, key);
			***REMOVED***
		***REMOVED***,
		has: function (key) {
			if ($m) {
				return $mapHas($m, key);
			***REMOVED***
			return false;
		***REMOVED***,
		set: function (key, value) {
			if (!$m) {
				// @ts-expect-error TS can't handle narrowing a variable inside a closure
				$m = new $Map();
			***REMOVED***
			$mapSet($m, key, value);
		***REMOVED***
	***REMOVED***;

	// @ts-expect-error TODO: figure out why TS is erroring here
	return channel;
***REMOVED***;
