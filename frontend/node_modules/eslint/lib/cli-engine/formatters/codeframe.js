/**
 * @fileoverview Codeframe reporter
 * @author Vitor Balocco
 */
"use strict";

const chalk = require("chalk");
const { codeFrameColumns ***REMOVED*** = require("@babel/code-frame");
const path = require("path");

//------------------------------------------------------------------------------
// Helpers
//------------------------------------------------------------------------------

/**
 * Given a word and a count, append an s if count is not one.
 * @param   {string***REMOVED*** word  A word in its singular form.
 * @param   {number***REMOVED*** count A number controlling whether word should be pluralized.
 * @returns {string***REMOVED***       The original word with an s on the end if count is not one.
 */
function pluralize(word, count) {
    return (count === 1 ? word : `${word***REMOVED***s`);
***REMOVED***

/**
 * Gets a formatted relative file path from an absolute path and a line/column in the file.
 * @param   {string***REMOVED*** filePath The absolute file path to format.
 * @param   {number***REMOVED*** line     The line from the file to use for formatting.
 * @param   {number***REMOVED*** column   The column from the file to use for formatting.
 * @returns {string***REMOVED***          The formatted file path.
 */
function formatFilePath(filePath, line, column) {
    let relPath = path.relative(process.cwd(), filePath);

    if (line && column) {
        relPath += `:${line***REMOVED***:${column***REMOVED***`;
    ***REMOVED***

    return chalk.green(relPath);
***REMOVED***

/**
 * Gets the formatted output for a given message.
 * @param   {Object***REMOVED*** message      The object that represents this message.
 * @param   {Object***REMOVED*** parentResult The result object that this message belongs to.
 * @returns {string***REMOVED***              The formatted output.
 */
function formatMessage(message, parentResult) {
    const type = (message.fatal || message.severity === 2) ? chalk.red("error") : chalk.yellow("warning");
    const msg = `${chalk.bold(message.message.replace(/([^ ])\.$/u, "$1"))***REMOVED***`;
    const ruleId = message.fatal ? "" : chalk.dim(`(${message.ruleId***REMOVED***)`);
    const filePath = formatFilePath(parentResult.filePath, message.line, message.column);
    const sourceCode = parentResult.output ? parentResult.output : parentResult.source;

    const firstLine = [
        `${type***REMOVED***:`,
        `${msg***REMOVED***`,
        ruleId ? `${ruleId***REMOVED***` : "",
        sourceCode ? `at ${filePath***REMOVED***:` : `at ${filePath***REMOVED***`
    ].filter(String).join(" ");

    const result = [firstLine];

    if (sourceCode) {
        result.push(
            codeFrameColumns(sourceCode, { start: { line: message.line, column: message.column ***REMOVED*** ***REMOVED***, { highlightCode: false ***REMOVED***)
        );
    ***REMOVED***

    return result.join("\n");
***REMOVED***

/**
 * Gets the formatted output summary for a given number of errors and warnings.
 * @param   {number***REMOVED*** errors   The number of errors.
 * @param   {number***REMOVED*** warnings The number of warnings.
 * @param   {number***REMOVED*** fixableErrors The number of fixable errors.
 * @param   {number***REMOVED*** fixableWarnings The number of fixable warnings.
 * @returns {string***REMOVED***          The formatted output summary.
 */
function formatSummary(errors, warnings, fixableErrors, fixableWarnings) {
    const summaryColor = errors > 0 ? "red" : "yellow";
    const summary = [];
    const fixablesSummary = [];

    if (errors > 0) {
        summary.push(`${errors***REMOVED*** ${pluralize("error", errors)***REMOVED***`);
    ***REMOVED***

    if (warnings > 0) {
        summary.push(`${warnings***REMOVED*** ${pluralize("warning", warnings)***REMOVED***`);
    ***REMOVED***

    if (fixableErrors > 0) {
        fixablesSummary.push(`${fixableErrors***REMOVED*** ${pluralize("error", fixableErrors)***REMOVED***`);
    ***REMOVED***

    if (fixableWarnings > 0) {
        fixablesSummary.push(`${fixableWarnings***REMOVED*** ${pluralize("warning", fixableWarnings)***REMOVED***`);
    ***REMOVED***

    let output = chalk[summaryColor].bold(`${summary.join(" and ")***REMOVED*** found.`);

    if (fixableErrors || fixableWarnings) {
        output += chalk[summaryColor].bold(`\n${fixablesSummary.join(" and ")***REMOVED*** potentially fixable with the \`--fix\` option.`);
    ***REMOVED***

    return output;
***REMOVED***

//------------------------------------------------------------------------------
// Public Interface
//------------------------------------------------------------------------------

module.exports = function(results) {
    let errors = 0;
    let warnings = 0;
    let fixableErrors = 0;
    let fixableWarnings = 0;

    const resultsWithMessages = results.filter(result => result.messages.length > 0);

    let output = resultsWithMessages.reduce((resultsOutput, result) => {
        const messages = result.messages.map(message => `${formatMessage(message, result)***REMOVED***\n\n`);

        errors += result.errorCount;
        warnings += result.warningCount;
        fixableErrors += result.fixableErrorCount;
        fixableWarnings += result.fixableWarningCount;

        return resultsOutput.concat(messages);
    ***REMOVED***, []).join("\n");

    output += "\n";
    output += formatSummary(errors, warnings, fixableErrors, fixableWarnings);

    return (errors + warnings) > 0 ? output : "";
***REMOVED***;
