var tape = require('tape')
var thunky = require('./')

tape('run only once', function (t) {
  t.plan(3)

  var ran = 0
  var run = thunky(function (cb) {
    ran++
    cb()
  ***REMOVED***)

  run(function () {
    t.same(ran, 1, 'ran once')
  ***REMOVED***)
  run(function () {
    t.same(ran, 1, 'ran once')
  ***REMOVED***)
  run(function () {
    t.same(ran, 1, 'ran once')
  ***REMOVED***)
***REMOVED***)

tape('run only once async', function (t) {
  t.plan(3)

  var ran = 0
  var run = thunky(function (cb) {
    process.nextTick(function () {
      ran++
      cb()
    ***REMOVED***)
  ***REMOVED***)

  run(function () {
    t.same(ran, 1, 'ran once')
  ***REMOVED***)
  run(function () {
    t.same(ran, 1, 'ran once')
  ***REMOVED***)
  run(function () {
    t.same(ran, 1, 'ran once')
  ***REMOVED***)
***REMOVED***)

tape('re-run on error', function (t) {
  t.plan(3)

  var ran = 0
  var run = thunky(function (cb) {
    ran++
    cb(new Error('stop'))
  ***REMOVED***)

  run(function () {
    t.same(ran, 1, 'ran once')
    run(function () {
      t.same(ran, 2, 'ran once')
      run(function () {
        t.same(ran, 3, 'ran once')
      ***REMOVED***)
    ***REMOVED***)
  ***REMOVED***)
***REMOVED***)

tape('pass arguments', function (t) {
  t.plan(6)

  var ran = 0
  var run = thunky(function (fn) {
    ran++
    fn({ hello: 'world' ***REMOVED***)
  ***REMOVED***)

  run(function (val) {
    t.same(ran, 1, 'ran once')
    t.same(val, { hello: 'world' ***REMOVED***)
    run(function (val) {
      t.same(ran, 1, 'ran once')
      t.same(val, { hello: 'world' ***REMOVED***)
      run(function (val) {
        t.same(ran, 1, 'ran once')
        t.same(val, { hello: 'world' ***REMOVED***)
      ***REMOVED***)
    ***REMOVED***)
  ***REMOVED***)
***REMOVED***)

tape('callback is optional', function (t) {
  t.plan(2)

  var ran = 0
  var run = thunky(function (fn) {
    ran++
    fn({ hello: 'world' ***REMOVED***)
  ***REMOVED***)

  run()
  run(function (val) {
    t.same(ran, 1, 'ran once')
    t.same(val, { hello: 'world' ***REMOVED***)
  ***REMOVED***)
***REMOVED***)

tape('always async', function (t) {
  t.plan(2)

  var run = thunky(function (cb) {
    process.nextTick(cb)
  ***REMOVED***)

  var sync = true
  run(function () {
    t.ok(!sync, 'not sync')
    var innerSync = true
    run(function () {
      t.ok(!innerSync, 'not sync')
    ***REMOVED***)
    innerSync = false
  ***REMOVED***)
  sync = false
***REMOVED***)
