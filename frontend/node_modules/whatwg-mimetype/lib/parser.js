"use strict";
const {
  removeLeadingAndTrailingHTTPWhitespace,
  removeTrailingHTTPWhitespace,
  isHTTPWhitespaceChar,
  solelyContainsHTTPTokenCodePoints,
  soleyContainsHTTPQuotedStringTokenCodePoints,
  asciiLowercase
***REMOVED*** = require("./utils.js");

module.exports = input => {
  input = removeLeadingAndTrailingHTTPWhitespace(input);

  let position = 0;
  let type = "";
  while (position < input.length && input[position] !== "/") {
    type += input[position];
    ++position;
  ***REMOVED***

  if (type.length === 0 || !solelyContainsHTTPTokenCodePoints(type)) {
    return null;
  ***REMOVED***

  if (position >= input.length) {
    return null;
  ***REMOVED***

  // Skips past "/"
  ++position;

  let subtype = "";
  while (position < input.length && input[position] !== ";") {
    subtype += input[position];
    ++position;
  ***REMOVED***

  subtype = removeTrailingHTTPWhitespace(subtype);

  if (subtype.length === 0 || !solelyContainsHTTPTokenCodePoints(subtype)) {
    return null;
  ***REMOVED***

  const mimeType = {
    type: asciiLowercase(type),
    subtype: asciiLowercase(subtype),
    parameters: new Map()
  ***REMOVED***;

  while (position < input.length) {
    // Skip past ";"
    ++position;

    while (isHTTPWhitespaceChar(input[position])) {
      ++position;
    ***REMOVED***

    let parameterName = "";
    while (position < input.length && input[position] !== ";" && input[position] !== "=") {
      parameterName += input[position];
      ++position;
    ***REMOVED***
    parameterName = asciiLowercase(parameterName);

    if (position < input.length) {
      if (input[position] === ";") {
        continue;
      ***REMOVED***

      // Skip past "="
      ++position;
    ***REMOVED***

    let parameterValue = "";
    if (input[position] === "\"") {
      ++position;

      while (true) {
        while (position < input.length && input[position] !== "\"" && input[position] !== "\\") {
          parameterValue += input[position];
          ++position;
        ***REMOVED***

        if (position < input.length && input[position] === "\\") {
          ++position;
          if (position < input.length) {
            parameterValue += input[position];
            ++position;
            continue;
          ***REMOVED*** else {
            parameterValue += "\\";
            break;
          ***REMOVED***
        ***REMOVED*** else {
          break;
        ***REMOVED***
      ***REMOVED***

      while (position < input.length && input[position] !== ";") {
        ++position;
      ***REMOVED***
    ***REMOVED*** else {
      while (position < input.length && input[position] !== ";") {
        parameterValue += input[position];
        ++position;
      ***REMOVED***

      parameterValue = removeTrailingHTTPWhitespace(parameterValue);

      if (parameterValue === "") {
        continue;
      ***REMOVED***
    ***REMOVED***

    if (parameterName.length > 0 &&
        solelyContainsHTTPTokenCodePoints(parameterName) &&
        soleyContainsHTTPQuotedStringTokenCodePoints(parameterValue) &&
        !mimeType.parameters.has(parameterName)) {
      mimeType.parameters.set(parameterName, parameterValue);
    ***REMOVED***
  ***REMOVED***

  return mimeType;
***REMOVED***;
