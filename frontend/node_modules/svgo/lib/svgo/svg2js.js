'use strict';

var SAX = require('sax'),
    JSAPI = require('./jsAPI.js'),
    CSSClassList = require('./css-class-list'),
    CSSStyleDeclaration = require('./css-style-declaration'),
    entityDeclaration = /<!ENTITY\s+(\S+)\s+(?:'([^\']+)'|"([^\"]+)")\s*>/g;

var config = {
    strict: true,
    trim: false,
    normalize: true,
    lowercase: true,
    xmlns: true,
    position: true
***REMOVED***;

/**
 * Convert SVG (XML) string to SVG-as-JS object.
 *
 * @param {String***REMOVED*** data input data
 * @param {Function***REMOVED*** callback
 */
module.exports = function(data, callback) {

    var sax = SAX.parser(config.strict, config),
        root = new JSAPI({ elem: '#document', content: [] ***REMOVED***),
        current = root,
        stack = [root],
        textContext = null,
        parsingError = false;

    function pushToContent(content) {

        content = new JSAPI(content, current);

        (current.content = current.content || []).push(content);

        return content;

    ***REMOVED***

    sax.ondoctype = function(doctype) {

        pushToContent({
            doctype: doctype
        ***REMOVED***);

        var subsetStart = doctype.indexOf('['),
            entityMatch;

        if (subsetStart >= 0) {
            entityDeclaration.lastIndex = subsetStart;

            while ((entityMatch = entityDeclaration.exec(data)) != null) {
                sax.ENTITIES[entityMatch[1]] = entityMatch[2] || entityMatch[3];
            ***REMOVED***
        ***REMOVED***
    ***REMOVED***;

    sax.onprocessinginstruction = function(data) {

        pushToContent({
            processinginstruction: data
        ***REMOVED***);

    ***REMOVED***;

    sax.oncomment = function(comment) {

        pushToContent({
            comment: comment.trim()
        ***REMOVED***);

    ***REMOVED***;

    sax.oncdata = function(cdata) {

        pushToContent({
            cdata: cdata
        ***REMOVED***);

    ***REMOVED***;

    sax.onopentag = function(data) {

        var elem = {
            elem: data.name,
            prefix: data.prefix,
            local: data.local,
            attrs: {***REMOVED***
        ***REMOVED***;

        elem.class = new CSSClassList(elem);
        elem.style = new CSSStyleDeclaration(elem);

        if (Object.keys(data.attributes).length) {
            for (var name in data.attributes) {

                if (name === 'class') { // has class attribute
                    elem.class.hasClass();
                ***REMOVED***

                if (name === 'style') { // has style attribute
                    elem.style.hasStyle();
                ***REMOVED***

                elem.attrs[name] = {
                    name: name,
                    value: data.attributes[name].value,
                    prefix: data.attributes[name].prefix,
                    local: data.attributes[name].local
                ***REMOVED***;
            ***REMOVED***
        ***REMOVED***

        elem = pushToContent(elem);
        current = elem;

        // Save info about <text> tag to prevent trimming of meaningful whitespace
        if (data.name == 'text' && !data.prefix) {
            textContext = current;
        ***REMOVED***

        stack.push(elem);

    ***REMOVED***;

    sax.ontext = function(text) {

        if (/\S/.test(text) || textContext) {

            if (!textContext)
                text = text.trim();

            pushToContent({
                text: text
            ***REMOVED***);

        ***REMOVED***

    ***REMOVED***;

    sax.onclosetag = function() {

        var last = stack.pop();

        // Trim text inside <text> tag.
        if (last == textContext) {
            trim(textContext);
            textContext = null;
        ***REMOVED***
        current = stack[stack.length - 1];

    ***REMOVED***;

    sax.onerror = function(e) {

        e.message = 'Error in parsing SVG: ' + e.message;
        if (e.message.indexOf('Unexpected end') < 0) {
            throw e;
        ***REMOVED***

    ***REMOVED***;

    sax.onend = function() {

        if (!this.error) {
            callback(root);
        ***REMOVED*** else {
            callback({ error: this.error.message ***REMOVED***);
        ***REMOVED***

    ***REMOVED***;

    try {
        sax.write(data);
    ***REMOVED*** catch (e) {
        callback({ error: e.message ***REMOVED***);
        parsingError = true;
    ***REMOVED***
    if (!parsingError) sax.close();

    function trim(elem) {
        if (!elem.content) return elem;

        var start = elem.content[0],
            end = elem.content[elem.content.length - 1];

        while (start && start.content && !start.text) start = start.content[0];
        if (start && start.text) start.text = start.text.replace(/^\s+/, '');

        while (end && end.content && !end.text) end = end.content[end.content.length - 1];
        if (end && end.text) end.text = end.text.replace(/\s+$/, '');

        return elem;

    ***REMOVED***

***REMOVED***;
