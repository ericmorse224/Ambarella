/*
  Copyright 2018 Google LLC

  Use of this source code is governed by an MIT-style
  license that can be found in the LICENSE file or at
  https://opensource.org/licenses/MIT.
*/

import fse from 'fs-extra';
import upath from 'upath';

import {bundle***REMOVED*** from './bundle';
import {errors***REMOVED*** from './errors';
import {GenerateSWOptions, ManifestEntry***REMOVED*** from '../types';
import {populateSWTemplate***REMOVED*** from './populate-sw-template';

export async function writeSWUsingDefaultTemplate({
  babelPresetEnvTargets,
  cacheId,
  cleanupOutdatedCaches,
  clientsClaim,
  directoryIndex,
  disableDevLogs,
  ignoreURLParametersMatching,
  importScripts,
  inlineWorkboxRuntime,
  manifestEntries,
  mode,
  navigateFallback,
  navigateFallbackDenylist,
  navigateFallbackAllowlist,
  navigationPreload,
  offlineGoogleAnalytics,
  runtimeCaching,
  skipWaiting,
  sourcemap,
  swDest,
***REMOVED***: GenerateSWOptions & {manifestEntries: Array<ManifestEntry>***REMOVED***): Promise<
  Array<string>
> {
  const outputDir = upath.dirname(swDest);
  try {
    await fse.mkdirp(outputDir);
  ***REMOVED*** catch (error) {
    throw new Error(
      `${errors['unable-to-make-sw-directory']***REMOVED***. ` +
        `'${error instanceof Error && error.message ? error.message : ''***REMOVED***'`,
    );
  ***REMOVED***

  const unbundledCode = populateSWTemplate({
    cacheId,
    cleanupOutdatedCaches,
    clientsClaim,
    directoryIndex,
    disableDevLogs,
    ignoreURLParametersMatching,
    importScripts,
    manifestEntries,
    navigateFallback,
    navigateFallbackDenylist,
    navigateFallbackAllowlist,
    navigationPreload,
    offlineGoogleAnalytics,
    runtimeCaching,
    skipWaiting,
  ***REMOVED***);

  try {
    const files = await bundle({
      babelPresetEnvTargets,
      inlineWorkboxRuntime,
      mode,
      sourcemap,
      swDest,
      unbundledCode,
    ***REMOVED***);

    const filePaths: Array<string> = [];

    for (const file of files) {
      const filePath = upath.resolve(file.name);
      filePaths.push(filePath);
      await fse.writeFile(filePath, file.contents);
    ***REMOVED***

    return filePaths;
  ***REMOVED*** catch (error) {
    const err = error as NodeJS.ErrnoException;
    if (err.code === 'EISDIR') {
      // See https://github.com/GoogleChrome/workbox/issues/612
      throw new Error(errors['sw-write-failure-directory']);
    ***REMOVED***
    throw new Error(`${errors['sw-write-failure']***REMOVED*** '${err.message***REMOVED***'`);
  ***REMOVED***
***REMOVED***
