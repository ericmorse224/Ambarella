'use strict';

var GetIntrinsic = require('get-intrinsic');
var callBound = require('call-bound');
var inspect = require('object-inspect');
var getSideChannelMap = require('side-channel-map');

var $TypeError = require('es-errors/type');
var $WeakMap = GetIntrinsic('%WeakMap%', true);

/** @type {<K extends object, V>(thisArg: WeakMap<K, V>, key: K) => V***REMOVED*** */
var $weakMapGet = callBound('WeakMap.prototype.get', true);
/** @type {<K extends object, V>(thisArg: WeakMap<K, V>, key: K, value: V) => void***REMOVED*** */
var $weakMapSet = callBound('WeakMap.prototype.set', true);
/** @type {<K extends object, V>(thisArg: WeakMap<K, V>, key: K) => boolean***REMOVED*** */
var $weakMapHas = callBound('WeakMap.prototype.has', true);
/** @type {<K extends object, V>(thisArg: WeakMap<K, V>, key: K) => boolean***REMOVED*** */
var $weakMapDelete = callBound('WeakMap.prototype.delete', true);

/** @type {import('.')***REMOVED*** */
module.exports = $WeakMap
	? /** @type {Exclude<import('.'), false>***REMOVED*** */ function getSideChannelWeakMap() {
		/** @typedef {ReturnType<typeof getSideChannelWeakMap>***REMOVED*** Channel */
		/** @typedef {Parameters<Channel['get']>[0]***REMOVED*** K */
		/** @typedef {Parameters<Channel['set']>[1]***REMOVED*** V */

		/** @type {WeakMap<K & object, V> | undefined***REMOVED*** */ var $wm;
		/** @type {Channel | undefined***REMOVED*** */ var $m;

		/** @type {Channel***REMOVED*** */
		var channel = {
			assert: function (key) {
				if (!channel.has(key)) {
					throw new $TypeError('Side channel does not contain ' + inspect(key));
				***REMOVED***
			***REMOVED***,
			'delete': function (key) {
				if ($WeakMap && key && (typeof key === 'object' || typeof key === 'function')) {
					if ($wm) {
						return $weakMapDelete($wm, key);
					***REMOVED***
				***REMOVED*** else if (getSideChannelMap) {
					if ($m) {
						return $m['delete'](key);
					***REMOVED***
				***REMOVED***
				return false;
			***REMOVED***,
			get: function (key) {
				if ($WeakMap && key && (typeof key === 'object' || typeof key === 'function')) {
					if ($wm) {
						return $weakMapGet($wm, key);
					***REMOVED***
				***REMOVED***
				return $m && $m.get(key);
			***REMOVED***,
			has: function (key) {
				if ($WeakMap && key && (typeof key === 'object' || typeof key === 'function')) {
					if ($wm) {
						return $weakMapHas($wm, key);
					***REMOVED***
				***REMOVED***
				return !!$m && $m.has(key);
			***REMOVED***,
			set: function (key, value) {
				if ($WeakMap && key && (typeof key === 'object' || typeof key === 'function')) {
					if (!$wm) {
						$wm = new $WeakMap();
					***REMOVED***
					$weakMapSet($wm, key, value);
				***REMOVED*** else if (getSideChannelMap) {
					if (!$m) {
						$m = getSideChannelMap();
					***REMOVED***
					// eslint-disable-next-line no-extra-parens
					/** @type {NonNullable<typeof $m>***REMOVED*** */ ($m).set(key, value);
				***REMOVED***
			***REMOVED***
		***REMOVED***;

		// @ts-expect-error TODO: figure out why this is erroring
		return channel;
	***REMOVED***
	: getSideChannelMap;
