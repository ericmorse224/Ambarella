'use strict';
const valueParser = require('postcss-value-parser');

const atrule = 'atrule';
const decl = 'decl';
const rule = 'rule';
const variableFunctions = new Set(['var', 'env', 'constant']);

/**
 * @param {valueParser.Node***REMOVED*** node
 * @return {void***REMOVED***
 */
function reduceCalcWhitespaces(node) {
  if (node.type === 'space') {
    node.value = ' ';
  ***REMOVED*** else if (node.type === 'function') {
    if (!variableFunctions.has(node.value.toLowerCase())) {
      node.before = node.after = '';
    ***REMOVED***
  ***REMOVED***
***REMOVED***
/**
 * @param {valueParser.Node***REMOVED*** node
 * @return {void | false***REMOVED***
 */
function reduceWhitespaces(node) {
  if (node.type === 'space') {
    node.value = ' ';
  ***REMOVED*** else if (node.type === 'div') {
    node.before = node.after = '';
  ***REMOVED*** else if (node.type === 'function') {
    if (!variableFunctions.has(node.value.toLowerCase())) {
      node.before = node.after = '';
    ***REMOVED***
    if (node.value.toLowerCase() === 'calc') {
      valueParser.walk(node.nodes, reduceCalcWhitespaces);
      return false;
    ***REMOVED***
  ***REMOVED***
***REMOVED***

/**
 * @type {import('postcss').PluginCreator<void>***REMOVED***
 * @return {import('postcss').Plugin***REMOVED***
 */
function pluginCreator() {
  return {
    postcssPlugin: 'postcss-normalize-whitespace',

    OnceExit(css) {
      const cache = new Map();

      css.walk((node) => {
        const { type ***REMOVED*** = node;

        if ([decl, rule, atrule].includes(type) && node.raws.before) {
          node.raws.before = node.raws.before.replace(/\s/g, '');
        ***REMOVED***

        if (type === decl) {
          // Ensure that !important values do not have any excess whitespace
          if (node.important) {
            node.raws.important = '!important';
          ***REMOVED***

          // Remove whitespaces around ie 9 hack
          node.value = node.value.replace(/\s*(\\9)\s*/, '$1');
          const value = node.value;

          if (cache.has(value)) {
            node.value = cache.get(value);
          ***REMOVED*** else {
            const parsed = valueParser(node.value);
            const result = parsed.walk(reduceWhitespaces).toString();

            // Trim whitespace inside functions & dividers
            node.value = result;
            cache.set(value, result);
          ***REMOVED***

          if (node.prop.startsWith('--') && node.value === '') {
            node.value = ' ';
          ***REMOVED***
          // Remove extra semicolons and whitespace before the declaration
          if (node.raws.before) {
            const prev = node.prev();

            if (prev && prev.type !== rule) {
              node.raws.before = node.raws.before.replace(/;/g, '');
            ***REMOVED***
          ***REMOVED***

          node.raws.between = ':';
          node.raws.semicolon = false;
        ***REMOVED*** else if (type === rule || type === atrule) {
          node.raws.between = node.raws.after = '';
          node.raws.semicolon = false;
        ***REMOVED***
      ***REMOVED***);

      // Remove final newline
      css.raws.after = '';
    ***REMOVED***,
  ***REMOVED***;
***REMOVED***

pluginCreator.postcss = true;
module.exports = pluginCreator;
