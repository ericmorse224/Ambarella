#!/bin/bash

# http://stackoverflow.com/a/246128
SOURCE="${BASH_SOURCE[0]***REMOVED***"
while [ -h "$SOURCE" ]; do # resolve $SOURCE until the file is no longer a symlink
  DIR="$( cd -P "$( dirname "$SOURCE" )" && pwd )"
  SOURCE="$(readlink "$SOURCE")"
  [[ $SOURCE != /* ]] && SOURCE="$DIR/$SOURCE" # if $SOURCE was a relative symlink, we need to resolve it relative to the path where the symlink file was located
done
JAKE_BIN_DIR="$( cd -P "$( dirname "$SOURCE" )" && pwd )"

# http://stackoverflow.com/a/12495480
# http://stackoverflow.com/a/28647824
_auto_jake()
{
    local cur
    local -a COMPGEN=()
    _get_comp_words_by_ref -n : -c cur
    
    # run auto-completions in jake via our auto_complete.js wrapper
    local -a auto_complete_info=( $(export COMP_LINE="${COMP_LINE***REMOVED***" && ${JAKE_BIN_DIR***REMOVED***/auto_complete.js "$cur" "${3***REMOVED***") )
    # check reply flag
    local reply_flag="${auto_complete_info[0]***REMOVED***"
    if [[ "${reply_flag***REMOVED***" == "no-complete" ]]; then
        return 1
    fi
    local auto_completions=("${auto_complete_info[@]:1***REMOVED***")
    COMPGEN=( $(compgen -W "${auto_completions[*]***REMOVED***" -- "$cur") )
    COMPREPLY=( "${COMPGEN[@]***REMOVED***" )
    
    __ltrim_colon_completions "$cur"
    
    # do we need another space??
    if [[ "${reply_flag***REMOVED***" == "yes-space" ]]; then
        COMPREPLY=( "${COMPGEN[@]***REMOVED***" " " )
    fi
    
    return 0
***REMOVED*** 

complete -o default -F _auto_jake jake
