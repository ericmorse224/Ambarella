/**
 * @fileoverview Flat Config Array
 * @author Nicholas C. Zakas
 */

"use strict";

//-----------------------------------------------------------------------------
// Requirements
//-----------------------------------------------------------------------------

const { ConfigArray, ConfigArraySymbol ***REMOVED*** = require("@humanwhocodes/config-array");
const { flatConfigSchema ***REMOVED*** = require("./flat-config-schema");
const { RuleValidator ***REMOVED*** = require("./rule-validator");
const { defaultConfig ***REMOVED*** = require("./default-config");
const recommendedConfig = require("../../conf/eslint-recommended");
const allConfig = require("../../conf/eslint-all");

//-----------------------------------------------------------------------------
// Helpers
//-----------------------------------------------------------------------------

const ruleValidator = new RuleValidator();

/**
 * Splits a plugin identifier in the form a/b/c into two parts: a/b and c.
 * @param {string***REMOVED*** identifier The identifier to parse.
 * @returns {{objectName: string, pluginName: string***REMOVED******REMOVED*** The parts of the plugin
 *      name.
 */
function splitPluginIdentifier(identifier) {
    const parts = identifier.split("/");

    return {
        objectName: parts.pop(),
        pluginName: parts.join("/")
    ***REMOVED***;
***REMOVED***

//-----------------------------------------------------------------------------
// Exports
//-----------------------------------------------------------------------------

/**
 * Represents an array containing configuration information for ESLint.
 */
class FlatConfigArray extends ConfigArray {

    /**
     * Creates a new instance.
     * @param {*[]***REMOVED*** configs An array of configuration information.
     * @param {{basePath: string, baseConfig: FlatConfig***REMOVED******REMOVED*** options The options
     *      to use for the config array instance.
     */
    constructor(configs, { basePath, baseConfig = defaultConfig ***REMOVED***) {
        super(configs, {
            basePath,
            schema: flatConfigSchema
        ***REMOVED***);

        this.unshift(baseConfig);
    ***REMOVED***

    /* eslint-disable class-methods-use-this */
    /**
     * Replaces a config with another config to allow us to put strings
     * in the config array that will be replaced by objects before
     * normalization.
     * @param {Object***REMOVED*** config The config to preprocess.
     * @returns {Object***REMOVED*** The preprocessed config.
     */
    [ConfigArraySymbol.preprocessConfig](config) {
        if (config === "eslint:recommended") {
            return recommendedConfig;
        ***REMOVED***

        if (config === "eslint:all") {
            return allConfig;
        ***REMOVED***

        return config;
    ***REMOVED***

    /**
     * Finalizes the config by replacing plugin references with their objects
     * and validating rule option schemas.
     * @param {Object***REMOVED*** config The config to finalize.
     * @returns {Object***REMOVED*** The finalized config.
     * @throws {TypeError***REMOVED*** If the config is invalid.
     */
    [ConfigArraySymbol.finalizeConfig](config) {

        const { plugins, languageOptions, processor ***REMOVED*** = config;

        // Check parser value
        if (languageOptions && languageOptions.parser && typeof languageOptions.parser === "string") {
            const { pluginName, objectName: parserName ***REMOVED*** = splitPluginIdentifier(languageOptions.parser);

            if (!plugins || !plugins[pluginName] || !plugins[pluginName].parsers || !plugins[pluginName].parsers[parserName]) {
                throw new TypeError(`Key "parser": Could not find "${parserName***REMOVED***" in plugin "${pluginName***REMOVED***".`);
            ***REMOVED***

            languageOptions.parser = plugins[pluginName].parsers[parserName];
        ***REMOVED***

        // Check processor value
        if (processor && typeof processor === "string") {
            const { pluginName, objectName: processorName ***REMOVED*** = splitPluginIdentifier(processor);

            if (!plugins || !plugins[pluginName] || !plugins[pluginName].processors || !plugins[pluginName].processors[processorName]) {
                throw new TypeError(`Key "processor": Could not find "${processorName***REMOVED***" in plugin "${pluginName***REMOVED***".`);
            ***REMOVED***

            config.processor = plugins[pluginName].processors[processorName];
        ***REMOVED***

        ruleValidator.validate(config);

        return config;
    ***REMOVED***
    /* eslint-enable class-methods-use-this */

***REMOVED***

exports.FlatConfigArray = FlatConfigArray;
