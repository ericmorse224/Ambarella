/*
  Copyright 2021 Google LLC

  Use of this source code is governed by an MIT-style
  license that can be found in the LICENSE file or at
  https://opensource.org/licenses/MIT.
*/

import assert from 'assert';

import {GetManifestResult, FileDetails, GetManifestOptions***REMOVED*** from '../types';
import {errors***REMOVED*** from './errors';
import {getCompositeDetails***REMOVED*** from './get-composite-details';
import {getFileDetails***REMOVED*** from './get-file-details';
import {getStringDetails***REMOVED*** from './get-string-details';
import {transformManifest***REMOVED*** from './transform-manifest';

export async function getFileManifestEntries({
  additionalManifestEntries,
  dontCacheBustURLsMatching,
  globDirectory,
  globFollow,
  globIgnores,
  globPatterns = [],
  globStrict,
  manifestTransforms,
  maximumFileSizeToCacheInBytes,
  modifyURLPrefix,
  templatedURLs,
***REMOVED***: GetManifestOptions): Promise<GetManifestResult> {
  const warnings: Array<string> = [];
  const allFileDetails = new Map<string, FileDetails>();

  try {
    for (const globPattern of globPatterns) {
      const {globbedFileDetails, warning***REMOVED*** = getFileDetails({
        globDirectory,
        globFollow,
        globIgnores,
        globPattern,
        globStrict,
      ***REMOVED***);

      if (warning) {
        warnings.push(warning);
      ***REMOVED***

      for (const details of globbedFileDetails) {
        if (details && !allFileDetails.has(details.file)) {
          allFileDetails.set(details.file, details);
        ***REMOVED***
      ***REMOVED***
    ***REMOVED***
  ***REMOVED*** catch (error) {
    // If there's an exception thrown while globbing, then report
    // it back as a warning, and don't consider it fatal.
    if (error instanceof Error && error.message) {
      warnings.push(error.message);
    ***REMOVED***
  ***REMOVED***

  if (templatedURLs) {
    for (const url of Object.keys(templatedURLs)) {
      assert(!allFileDetails.has(url), errors['templated-url-matches-glob']);

      const dependencies = templatedURLs[url];
      if (Array.isArray(dependencies)) {
        const details = dependencies.reduce<Array<FileDetails>>(
          (previous, globPattern) => {
            try {
              const {globbedFileDetails, warning***REMOVED*** = getFileDetails({
                globDirectory,
                globFollow,
                globIgnores,
                globPattern,
                globStrict,
              ***REMOVED***);

              if (warning) {
                warnings.push(warning);
              ***REMOVED***

              return previous.concat(globbedFileDetails);
            ***REMOVED*** catch (error) {
              const debugObj: {[key: string]: Array<string>***REMOVED*** = {***REMOVED***;
              debugObj[url] = dependencies;
              throw new Error(
                `${errors['bad-template-urls-asset']***REMOVED*** ` +
                  `'${globPattern***REMOVED***' from '${JSON.stringify(debugObj)***REMOVED***':\n` +
                  `${error instanceof Error ? error.toString() : ''***REMOVED***`,
              );
            ***REMOVED***
          ***REMOVED***,
          [],
        );
        if (details.length === 0) {
          throw new Error(
            `${errors['bad-template-urls-asset']***REMOVED*** The glob ` +
              `pattern '${dependencies.toString()***REMOVED***' did not match anything.`,
          );
        ***REMOVED***
        allFileDetails.set(url, getCompositeDetails(url, details));
      ***REMOVED*** else if (typeof dependencies === 'string') {
        allFileDetails.set(url, getStringDetails(url, dependencies));
      ***REMOVED***
    ***REMOVED***
  ***REMOVED***

  const transformedManifest = await transformManifest({
    additionalManifestEntries,
    dontCacheBustURLsMatching,
    manifestTransforms,
    maximumFileSizeToCacheInBytes,
    modifyURLPrefix,
    fileDetails: Array.from(allFileDetails.values()),
  ***REMOVED***);

  transformedManifest.warnings.push(...warnings);

  return transformedManifest;
***REMOVED***
