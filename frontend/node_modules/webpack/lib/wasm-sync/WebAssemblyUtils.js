/*
	MIT License http://www.opensource.org/licenses/mit-license.php
	Author Tobias Koppers @sokra
*/

"use strict";

const Template = require("../Template");
const WebAssemblyImportDependency = require("../dependencies/WebAssemblyImportDependency");

/** @typedef {import("../Module")***REMOVED*** Module */
/** @typedef {import("../ModuleGraph")***REMOVED*** ModuleGraph */

/**
 * @typedef {object***REMOVED*** UsedWasmDependency
 * @property {WebAssemblyImportDependency***REMOVED*** dependency the dependency
 * @property {string***REMOVED*** name the export name
 * @property {string***REMOVED*** module the module name
 */

const MANGLED_MODULE = "a";

/**
 * @param {ModuleGraph***REMOVED*** moduleGraph the module graph
 * @param {Module***REMOVED*** module the module
 * @param {boolean | undefined***REMOVED*** mangle mangle module and export names
 * @returns {UsedWasmDependency[]***REMOVED*** used dependencies and (mangled) name
 */
const getUsedDependencies = (moduleGraph, module, mangle) => {
	/** @type {UsedWasmDependency[]***REMOVED*** */
	const array = [];
	let importIndex = 0;
	for (const dep of module.dependencies) {
		if (dep instanceof WebAssemblyImportDependency) {
			if (
				dep.description.type === "GlobalType" ||
				moduleGraph.getModule(dep) === null
			) {
				continue;
			***REMOVED***

			const exportName = dep.name;
			// TODO add the following 3 lines when removing of ModuleExport is possible
			// const importedModule = moduleGraph.getModule(dep);
			// const usedName = importedModule && moduleGraph.getExportsInfo(importedModule).getUsedName(exportName, runtime);
			// if (usedName !== false) {
			if (mangle) {
				array.push({
					dependency: dep,
					name: Template.numberToIdentifier(importIndex++),
					module: MANGLED_MODULE
				***REMOVED***);
			***REMOVED*** else {
				array.push({
					dependency: dep,
					name: exportName,
					module: dep.request
				***REMOVED***);
			***REMOVED***
		***REMOVED***
	***REMOVED***
	return array;
***REMOVED***;

module.exports.getUsedDependencies = getUsedDependencies;
module.exports.MANGLED_MODULE = MANGLED_MODULE;
