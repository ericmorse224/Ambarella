var mdns = require('./')
var tape = require('tape')
var dgram = require('dgram')

var port = function (cb) {
  var s = dgram.createSocket('udp4')
  s.bind(0, function () {
    var port = s.address().port
    s.on('close', function () {
      cb(port)
    ***REMOVED***)
    s.close()
  ***REMOVED***)
***REMOVED***

var configs = [
  {ip: '127.0.0.1', multicast: false***REMOVED***
  // {'interface': '127.0.0.1', multicast: true***REMOVED***
]

var tests = configs.map(function (config) {
  return function (name, fn) {
    tape(name, function (t) {
      port(function (p) {
        config.port = p
        var dns = mdns(config)
        dns.on('warning', function (e) {
          t.error(e)
        ***REMOVED***)
        fn(dns, t)
      ***REMOVED***)
    ***REMOVED***)
  ***REMOVED***
***REMOVED***)

tests.forEach(function (test) {
  test('works', function (dns, t) {
    t.plan(3)

    dns.once('query', function (packet) {
      t.same(packet.type, 'query')
      dns.destroy(function () {
        t.ok(true, 'destroys')
      ***REMOVED***)
    ***REMOVED***)

    dns.query('hello-world', function () {
      t.ok(true, 'flushed')
    ***REMOVED***)
  ***REMOVED***)

  test('ANY query', function (dns, t) {
    dns.once('query', function (packet) {
      t.same(packet.questions.length, 1, 'one question')
      t.same(packet.questions[0], {name: 'hello-world', type: 'ANY', class: 'IN'***REMOVED***)
      dns.destroy(function () {
        t.end()
      ***REMOVED***)
    ***REMOVED***)

    dns.query('hello-world', 'ANY')
  ***REMOVED***)

  test('A record', function (dns, t) {
    dns.once('query', function (packet) {
      t.same(packet.questions.length, 1, 'one question')
      t.same(packet.questions[0], {name: 'hello-world', type: 'A', class: 'IN'***REMOVED***)
      dns.respond([{type: 'A', name: 'hello-world', ttl: 120, data: '127.0.0.1'***REMOVED***])
    ***REMOVED***)

    dns.once('response', function (packet) {
      t.same(packet.answers.length, 1, 'one answer')
      t.same(packet.answers[0], {type: 'A', name: 'hello-world', ttl: 120, data: '127.0.0.1', class: 'IN', flush: false***REMOVED***)
      dns.destroy(function () {
        t.end()
      ***REMOVED***)
    ***REMOVED***)

    dns.query('hello-world', 'A')
  ***REMOVED***)

  test('A record (two questions)', function (dns, t) {
    dns.once('query', function (packet) {
      t.same(packet.questions.length, 2, 'two questions')
      t.same(packet.questions[0], {name: 'hello-world', type: 'A', class: 'IN'***REMOVED***)
      t.same(packet.questions[1], {name: 'hej.verden', type: 'A', class: 'IN'***REMOVED***)
      dns.respond([{type: 'A', name: 'hello-world', ttl: 120, data: '127.0.0.1'***REMOVED***, {
        type: 'A',
        name: 'hej.verden',
        ttl: 120,
        data: '127.0.0.2'
      ***REMOVED***])
    ***REMOVED***)

    dns.once('response', function (packet) {
      t.same(packet.answers.length, 2, 'one answers')
      t.same(packet.answers[0], {type: 'A', name: 'hello-world', ttl: 120, data: '127.0.0.1', class: 'IN', flush: false***REMOVED***)
      t.same(packet.answers[1], {type: 'A', name: 'hej.verden', ttl: 120, data: '127.0.0.2', class: 'IN', flush: false***REMOVED***)
      dns.destroy(function () {
        t.end()
      ***REMOVED***)
    ***REMOVED***)

    dns.query([{name: 'hello-world', type: 'A'***REMOVED***, {name: 'hej.verden', type: 'A'***REMOVED***])
  ***REMOVED***)

  test('AAAA record', function (dns, t) {
    dns.once('query', function (packet) {
      t.same(packet.questions.length, 1, 'one question')
      t.same(packet.questions[0], {name: 'hello-world', type: 'AAAA', class: 'IN'***REMOVED***)
      dns.respond([{type: 'AAAA', name: 'hello-world', ttl: 120, data: 'fe80::5ef9:38ff:fe8c:ceaa'***REMOVED***])
    ***REMOVED***)

    dns.once('response', function (packet) {
      t.same(packet.answers.length, 1, 'one answer')
      t.same(packet.answers[0], {
        type: 'AAAA',
        name: 'hello-world',
        ttl: 120,
        data: 'fe80::5ef9:38ff:fe8c:ceaa',
        class: 'IN',
        flush: false
      ***REMOVED***)
      dns.destroy(function () {
        t.end()
      ***REMOVED***)
    ***REMOVED***)

    dns.query('hello-world', 'AAAA')
  ***REMOVED***)

  test('SRV record', function (dns, t) {
    dns.once('query', function (packet) {
      t.same(packet.questions.length, 1, 'one question')
      t.same(packet.questions[0], {name: 'hello-world', type: 'SRV', class: 'IN'***REMOVED***)
      dns.respond([{
        type: 'SRV',
        name: 'hello-world',
        ttl: 120,
        data: {port: 11111, target: 'hello.world.com', priority: 10, weight: 12***REMOVED***
      ***REMOVED***])
    ***REMOVED***)

    dns.once('response', function (packet) {
      t.same(packet.answers.length, 1, 'one answer')
      t.same(packet.answers[0], {
        type: 'SRV',
        name: 'hello-world',
        ttl: 120,
        data: {port: 11111, target: 'hello.world.com', priority: 10, weight: 12***REMOVED***,
        class: 'IN',
        flush: false
      ***REMOVED***)
      dns.destroy(function () {
        t.end()
      ***REMOVED***)
    ***REMOVED***)

    dns.query('hello-world', 'SRV')
  ***REMOVED***)

  test('TXT record', function (dns, t) {
    var data = [Buffer.from('black box')]

    dns.once('query', function (packet) {
      t.same(packet.questions.length, 1, 'one question')
      t.same(packet.questions[0], {name: 'hello-world', type: 'TXT', class: 'IN'***REMOVED***)
      dns.respond([{type: 'TXT', name: 'hello-world', ttl: 120, data: data***REMOVED***])
    ***REMOVED***)

    dns.once('response', function (packet) {
      t.same(packet.answers.length, 1, 'one answer')
      t.same(packet.answers[0], {type: 'TXT', name: 'hello-world', ttl: 120, data: data, class: 'IN', flush: false***REMOVED***)
      dns.destroy(function () {
        t.end()
      ***REMOVED***)
    ***REMOVED***)

    dns.query('hello-world', 'TXT')
  ***REMOVED***)

  test('TXT array record', function (dns, t) {
    var data = ['black', 'box']

    dns.once('query', function (packet) {
      t.same(packet.questions.length, 1, 'one question')
      t.same(packet.questions[0], {name: 'hello-world', type: 'TXT', class: 'IN'***REMOVED***)
      dns.respond([{type: 'TXT', name: 'hello-world', ttl: 120, data: data***REMOVED***])
    ***REMOVED***)

    dns.once('response', function (packet) {
      t.same(packet.answers.length, 1, 'one answer')
      t.same(packet.answers[0], {type: 'TXT', name: 'hello-world', ttl: 120, data: data, class: 'IN', flush: false***REMOVED***)
      dns.destroy(function () {
        t.end()
      ***REMOVED***)
    ***REMOVED***)

    dns.query('hello-world', 'TXT')
  ***REMOVED***)

  test('QU question bit', function (dns, t) {
    dns.once('query', function (packet) {
      t.same(packet.questions, [
        {type: 'A', name: 'foo', class: 'IN'***REMOVED***,
        {type: 'A', name: 'bar', class: 'IN'***REMOVED***
      ])
      dns.destroy(function () {
        t.end()
      ***REMOVED***)
    ***REMOVED***)

    dns.query([
      {type: 'A', name: 'foo', class: 'IN'***REMOVED***,
      {type: 'A', name: 'bar', class: 'IN'***REMOVED***
    ])
  ***REMOVED***)

  test('cache flush bit', function (dns, t) {
    dns.once('query', function (packet) {
      dns.respond({
        answers: [
          {type: 'A', name: 'foo', ttl: 120, data: '127.0.0.1', class: 'IN', flush: true***REMOVED***,
          {type: 'A', name: 'foo', ttl: 120, data: '127.0.0.2', class: 'IN', flush: false***REMOVED***
        ],
        additionals: [
          {type: 'A', name: 'foo', ttl: 120, data: '127.0.0.3', class: 'IN', flush: true***REMOVED***
        ]
      ***REMOVED***)
    ***REMOVED***)

    dns.once('response', function (packet) {
      t.same(packet.answers, [
        {type: 'A', name: 'foo', ttl: 120, data: '127.0.0.1', class: 'IN', flush: true***REMOVED***,
        {type: 'A', name: 'foo', ttl: 120, data: '127.0.0.2', class: 'IN', flush: false***REMOVED***
      ])
      t.same(packet.additionals[0], {type: 'A', name: 'foo', ttl: 120, data: '127.0.0.3', class: 'IN', flush: true***REMOVED***)
      dns.destroy(function () {
        t.end()
      ***REMOVED***)
    ***REMOVED***)

    dns.query('foo', 'A')
  ***REMOVED***)

  test('Authoritive Answer bit', function (dns, t) {
    dns.once('query', function (packet) {
      dns.respond([])
    ***REMOVED***)

    dns.once('response', function (packet) {
      t.ok(packet.flag_aa, 'should be set')
      dns.destroy(function () {
        t.end()
      ***REMOVED***)
    ***REMOVED***)

    dns.query('foo', 'A')
  ***REMOVED***)
***REMOVED***)
