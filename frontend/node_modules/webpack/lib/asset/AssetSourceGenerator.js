/*
	MIT License http://www.opensource.org/licenses/mit-license.php
	Author Sergey Melyukov @smelukov
*/

"use strict";

const { RawSource ***REMOVED*** = require("webpack-sources");
const ConcatenationScope = require("../ConcatenationScope");
const Generator = require("../Generator");
const {
	NO_TYPES,
	CSS_URL_TYPES,
	JS_TYPES,
	JS_AND_CSS_URL_TYPES
***REMOVED*** = require("../ModuleSourceTypesConstants");
const RuntimeGlobals = require("../RuntimeGlobals");

/** @typedef {import("webpack-sources").Source***REMOVED*** Source */
/** @typedef {import("../Generator").GenerateContext***REMOVED*** GenerateContext */
/** @typedef {import("../Module").ConcatenationBailoutReasonContext***REMOVED*** ConcatenationBailoutReasonContext */
/** @typedef {import("../Module").SourceTypes***REMOVED*** SourceTypes */
/** @typedef {import("../ModuleGraph")***REMOVED*** ModuleGraph */
/** @typedef {import("../NormalModule")***REMOVED*** NormalModule */

class AssetSourceGenerator extends Generator {
	/**
	 * @param {ModuleGraph***REMOVED*** moduleGraph the module graph
	 */
	constructor(moduleGraph) {
		super();

		this._moduleGraph = moduleGraph;
	***REMOVED***

	/**
	 * @param {NormalModule***REMOVED*** module module for which the code should be generated
	 * @param {GenerateContext***REMOVED*** generateContext context for generate
	 * @returns {Source | null***REMOVED*** generated code
	 */
	generate(
		module,
		{ type, concatenationScope, getData, runtimeTemplate, runtimeRequirements ***REMOVED***
	) {
		const originalSource = module.originalSource();
		const data = getData ? getData() : undefined;

		switch (type) {
			case "javascript": {
				if (!originalSource) {
					return new RawSource("");
				***REMOVED***

				const content = originalSource.source();
				const encodedSource =
					typeof content === "string" ? content : content.toString("utf-8");

				let sourceContent;
				if (concatenationScope) {
					concatenationScope.registerNamespaceExport(
						ConcatenationScope.NAMESPACE_OBJECT_EXPORT
					);
					sourceContent = `${runtimeTemplate.supportsConst() ? "const" : "var"***REMOVED*** ${
						ConcatenationScope.NAMESPACE_OBJECT_EXPORT
					***REMOVED*** = ${JSON.stringify(encodedSource)***REMOVED***;`;
				***REMOVED*** else {
					runtimeRequirements.add(RuntimeGlobals.module);
					sourceContent = `${RuntimeGlobals.module***REMOVED***.exports = ${JSON.stringify(
						encodedSource
					)***REMOVED***;`;
				***REMOVED***
				return new RawSource(sourceContent);
			***REMOVED***
			case "css-url": {
				if (!originalSource) {
					return null;
				***REMOVED***

				const content = originalSource.source();
				const encodedSource =
					typeof content === "string" ? content : content.toString("utf-8");

				if (data) {
					data.set("url", { [type]: encodedSource ***REMOVED***);
				***REMOVED***
				return null;
			***REMOVED***
			default:
				return null;
		***REMOVED***
	***REMOVED***

	/**
	 * @param {Error***REMOVED*** error the error
	 * @param {NormalModule***REMOVED*** module module for which the code should be generated
	 * @param {GenerateContext***REMOVED*** generateContext context for generate
	 * @returns {Source | null***REMOVED*** generated code
	 */
	generateError(error, module, generateContext) {
		switch (generateContext.type) {
			case "javascript": {
				return new RawSource(
					`throw new Error(${JSON.stringify(error.message)***REMOVED***);`
				);
			***REMOVED***
			default:
				return null;
		***REMOVED***
	***REMOVED***

	/**
	 * @param {NormalModule***REMOVED*** module module for which the bailout reason should be determined
	 * @param {ConcatenationBailoutReasonContext***REMOVED*** context context
	 * @returns {string | undefined***REMOVED*** reason why this module can't be concatenated, undefined when it can be concatenated
	 */
	getConcatenationBailoutReason(module, context) {
		return undefined;
	***REMOVED***

	/**
	 * @param {NormalModule***REMOVED*** module fresh module
	 * @returns {SourceTypes***REMOVED*** available types (do not mutate)
	 */
	getTypes(module) {
		const sourceTypes = new Set();
		const connections = this._moduleGraph.getIncomingConnections(module);

		for (const connection of connections) {
			if (!connection.originModule) {
				continue;
			***REMOVED***

			sourceTypes.add(connection.originModule.type.split("/")[0]);
		***REMOVED***

		if (sourceTypes.has("javascript") && sourceTypes.has("css")) {
			return JS_AND_CSS_URL_TYPES;
		***REMOVED*** else if (sourceTypes.has("javascript")) {
			return JS_TYPES;
		***REMOVED*** else if (sourceTypes.has("css")) {
			return CSS_URL_TYPES;
		***REMOVED***

		return NO_TYPES;
	***REMOVED***

	/**
	 * @param {NormalModule***REMOVED*** module the module
	 * @param {string=***REMOVED*** type source type
	 * @returns {number***REMOVED*** estimate size of the module
	 */
	getSize(module, type) {
		const originalSource = module.originalSource();

		if (!originalSource) {
			return 0;
		***REMOVED***

		// Example: m.exports="abcd"
		return originalSource.size() + 12;
	***REMOVED***
***REMOVED***

module.exports = AssetSourceGenerator;
