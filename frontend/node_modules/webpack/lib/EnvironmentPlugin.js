/*
	MIT License http://www.opensource.org/licenses/mit-license.php
	Authors Simen Brekken @simenbrekken, Einar LÃ¶ve @einarlove
*/

"use strict";

const DefinePlugin = require("./DefinePlugin");
const WebpackError = require("./WebpackError");

/** @typedef {import("./Compiler")***REMOVED*** Compiler */
/** @typedef {import("./DefinePlugin").CodeValue***REMOVED*** CodeValue */

const PLUGIN_NAME = "EnvironmentPlugin";

class EnvironmentPlugin {
	/**
	 * @param {(string | string[] | Record<string, EXPECTED_ANY>)[]***REMOVED*** keys keys
	 */
	constructor(...keys) {
		if (keys.length === 1 && Array.isArray(keys[0])) {
			/** @type {string[]***REMOVED*** */
			this.keys = keys[0];
			this.defaultValues = {***REMOVED***;
		***REMOVED*** else if (keys.length === 1 && keys[0] && typeof keys[0] === "object") {
			this.keys = Object.keys(keys[0]);
			this.defaultValues =
				/** @type {Record<string, EXPECTED_ANY>***REMOVED*** */
				(keys[0]);
		***REMOVED*** else {
			this.keys = /** @type {string[]***REMOVED*** */ (keys);
			this.defaultValues = {***REMOVED***;
		***REMOVED***
	***REMOVED***

	/**
	 * Apply the plugin
	 * @param {Compiler***REMOVED*** compiler the compiler instance
	 * @returns {void***REMOVED***
	 */
	apply(compiler) {
		/** @type {Record<string, CodeValue>***REMOVED*** */
		const definitions = {***REMOVED***;
		for (const key of this.keys) {
			const value =
				process.env[key] !== undefined
					? process.env[key]
					: this.defaultValues[key];

			if (value === undefined) {
				compiler.hooks.thisCompilation.tap(PLUGIN_NAME, compilation => {
					const error = new WebpackError(
						`${PLUGIN_NAME***REMOVED*** - ${key***REMOVED*** environment variable is undefined.\n\n` +
							"You can pass an object with default values to suppress this warning.\n" +
							"See https://webpack.js.org/plugins/environment-plugin for example."
					);

					error.name = "EnvVariableNotDefinedError";
					compilation.errors.push(error);
				***REMOVED***);
			***REMOVED***

			definitions[`process.env.${key***REMOVED***`] =
				value === undefined ? "undefined" : JSON.stringify(value);
		***REMOVED***

		new DefinePlugin(definitions).apply(compiler);
	***REMOVED***
***REMOVED***

module.exports = EnvironmentPlugin;
