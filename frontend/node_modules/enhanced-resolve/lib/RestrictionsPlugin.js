/*
	MIT License http://www.opensource.org/licenses/mit-license.php
	Author Ivan Kopeykin @vankop
*/

"use strict";

/** @typedef {import("./Resolver")***REMOVED*** Resolver */
/** @typedef {import("./Resolver").ResolveStepHook***REMOVED*** ResolveStepHook */

const slashCode = "/".charCodeAt(0);
const backslashCode = "\\".charCodeAt(0);

/**
 * @param {string***REMOVED*** path path
 * @param {string***REMOVED*** parent parent path
 * @returns {boolean***REMOVED*** true, if path is inside of parent
 */
const isInside = (path, parent) => {
	if (!path.startsWith(parent)) return false;
	if (path.length === parent.length) return true;
	const charCode = path.charCodeAt(parent.length);
	return charCode === slashCode || charCode === backslashCode;
***REMOVED***;

module.exports = class RestrictionsPlugin {
	/**
	 * @param {string | ResolveStepHook***REMOVED*** source source
	 * @param {Set<string | RegExp>***REMOVED*** restrictions restrictions
	 */
	constructor(source, restrictions) {
		this.source = source;
		this.restrictions = restrictions;
	***REMOVED***

	/**
	 * @param {Resolver***REMOVED*** resolver the resolver
	 * @returns {void***REMOVED***
	 */
	apply(resolver) {
		resolver
			.getHook(this.source)
			.tapAsync("RestrictionsPlugin", (request, resolveContext, callback) => {
				if (typeof request.path === "string") {
					const path = request.path;
					for (const rule of this.restrictions) {
						if (typeof rule === "string") {
							if (!isInside(path, rule)) {
								if (resolveContext.log) {
									resolveContext.log(
										`${path***REMOVED*** is not inside of the restriction ${rule***REMOVED***`
									);
								***REMOVED***
								return callback(null, null);
							***REMOVED***
						***REMOVED*** else if (!rule.test(path)) {
							if (resolveContext.log) {
								resolveContext.log(
									`${path***REMOVED*** doesn't match the restriction ${rule***REMOVED***`
								);
							***REMOVED***
							return callback(null, null);
						***REMOVED***
					***REMOVED***
				***REMOVED***

				callback();
			***REMOVED***);
	***REMOVED***
***REMOVED***;
