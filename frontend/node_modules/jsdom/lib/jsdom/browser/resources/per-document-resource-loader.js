"use strict";
const idlUtils = require("../../living/generated/utils");
const { fireAnEvent ***REMOVED*** = require("../../living/helpers/events");

module.exports = class PerDocumentResourceLoader {
  constructor(document) {
    this._document = document;
    this._defaultEncoding = document._encoding;
    this._resourceLoader = document._defaultView ? document._defaultView._resourceLoader : null;
    this._requestManager = document._requestManager;
    this._queue = document._queue;
    this._deferQueue = document._deferQueue;
    this._asyncQueue = document._asyncQueue;
  ***REMOVED***

  fetch(url, { element, onLoad, onError ***REMOVED***) {
    const request = this._resourceLoader.fetch(url, {
      cookieJar: this._document._cookieJar,
      element: idlUtils.wrapperForImpl(element),
      referrer: this._document.URL
    ***REMOVED***);

    if (request === null) {
      return null;
    ***REMOVED***

    this._requestManager.add(request);

    const onErrorWrapped = error => {
      this._requestManager.remove(request);

      if (onError) {
        onError(error);
      ***REMOVED***

      fireAnEvent("error", element);

      const err = new Error(`Could not load ${element.localName***REMOVED***: "${url***REMOVED***"`);
      err.type = "resource loading";
      err.detail = error;

      this._document._defaultView._virtualConsole.emit("jsdomError", err);

      return Promise.resolve();
    ***REMOVED***;

    const onLoadWrapped = data => {
      this._requestManager.remove(request);

      this._addCookies(url, request.response ? request.response.headers : {***REMOVED***);

      try {
        const result = onLoad ? onLoad(data) : undefined;

        return Promise.resolve(result)
          .then(() => {
            fireAnEvent("load", element);

            return Promise.resolve();
          ***REMOVED***)
          .catch(err => {
            return onErrorWrapped(err);
          ***REMOVED***);
      ***REMOVED*** catch (err) {
        return onErrorWrapped(err);
      ***REMOVED***
    ***REMOVED***;

    if (element.localName === "script" && element.hasAttributeNS(null, "async")) {
      this._asyncQueue.push(request, onLoadWrapped, onErrorWrapped, this._queue.getLastScript());
    ***REMOVED*** else if (element.localName === "script" && element.hasAttributeNS(null, "defer")) {
      this._deferQueue.push(request, onLoadWrapped, onErrorWrapped, false, element);
    ***REMOVED*** else {
      this._queue.push(request, onLoadWrapped, onErrorWrapped, false, element);
    ***REMOVED***

    return request;
  ***REMOVED***

  _addCookies(url, headers) {
    let cookies = headers["set-cookie"];

    if (!cookies) {
      return;
    ***REMOVED***

    if (!Array.isArray(cookies)) {
      cookies = [cookies];
    ***REMOVED***

    cookies.forEach(cookie => {
      this._document._cookieJar.setCookieSync(cookie, url, { http: true, ignoreError: true ***REMOVED***);
    ***REMOVED***);
  ***REMOVED***
***REMOVED***;
