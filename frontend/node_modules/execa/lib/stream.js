'use strict';
const isStream = require('is-stream');
const getStream = require('get-stream');
const mergeStream = require('merge-stream');

// `input` option
const handleInput = (spawned, input) => {
	// Checking for stdin is workaround for https://github.com/nodejs/node/issues/26852
	// @todo remove `|| spawned.stdin === undefined` once we drop support for Node.js <=12.2.0
	if (input === undefined || spawned.stdin === undefined) {
		return;
	***REMOVED***

	if (isStream(input)) {
		input.pipe(spawned.stdin);
	***REMOVED*** else {
		spawned.stdin.end(input);
	***REMOVED***
***REMOVED***;

// `all` interleaves `stdout` and `stderr`
const makeAllStream = (spawned, {all***REMOVED***) => {
	if (!all || (!spawned.stdout && !spawned.stderr)) {
		return;
	***REMOVED***

	const mixed = mergeStream();

	if (spawned.stdout) {
		mixed.add(spawned.stdout);
	***REMOVED***

	if (spawned.stderr) {
		mixed.add(spawned.stderr);
	***REMOVED***

	return mixed;
***REMOVED***;

// On failure, `result.stdout|stderr|all` should contain the currently buffered stream
const getBufferedData = async (stream, streamPromise) => {
	if (!stream) {
		return;
	***REMOVED***

	stream.destroy();

	try {
		return await streamPromise;
	***REMOVED*** catch (error) {
		return error.bufferedData;
	***REMOVED***
***REMOVED***;

const getStreamPromise = (stream, {encoding, buffer, maxBuffer***REMOVED***) => {
	if (!stream || !buffer) {
		return;
	***REMOVED***

	if (encoding) {
		return getStream(stream, {encoding, maxBuffer***REMOVED***);
	***REMOVED***

	return getStream.buffer(stream, {maxBuffer***REMOVED***);
***REMOVED***;

// Retrieve result of child process: exit code, signal, error, streams (stdout/stderr/all)
const getSpawnedResult = async ({stdout, stderr, all***REMOVED***, {encoding, buffer, maxBuffer***REMOVED***, processDone) => {
	const stdoutPromise = getStreamPromise(stdout, {encoding, buffer, maxBuffer***REMOVED***);
	const stderrPromise = getStreamPromise(stderr, {encoding, buffer, maxBuffer***REMOVED***);
	const allPromise = getStreamPromise(all, {encoding, buffer, maxBuffer: maxBuffer * 2***REMOVED***);

	try {
		return await Promise.all([processDone, stdoutPromise, stderrPromise, allPromise]);
	***REMOVED*** catch (error) {
		return Promise.all([
			{error, signal: error.signal, timedOut: error.timedOut***REMOVED***,
			getBufferedData(stdout, stdoutPromise),
			getBufferedData(stderr, stderrPromise),
			getBufferedData(all, allPromise)
		]);
	***REMOVED***
***REMOVED***;

const validateInputSync = ({input***REMOVED***) => {
	if (isStream(input)) {
		throw new TypeError('The `input` option cannot be a stream in sync mode');
	***REMOVED***
***REMOVED***;

module.exports = {
	handleInput,
	makeAllStream,
	getSpawnedResult,
	validateInputSync
***REMOVED***;

