'use strict';

const $ = exports;

const el = require('./elements');

const noop = v => v;

function toPrompt(type, args, opts = {***REMOVED***) {
  return new Promise((res, rej) => {
    const p = new el[type](args);
    const onAbort = opts.onAbort || noop;
    const onSubmit = opts.onSubmit || noop;
    const onExit = opts.onExit || noop;
    p.on('state', args.onState || noop);
    p.on('submit', x => res(onSubmit(x)));
    p.on('exit', x => res(onExit(x)));
    p.on('abort', x => rej(onAbort(x)));
  ***REMOVED***);
***REMOVED***
/**
 * Text prompt
 * @param {string***REMOVED*** args.message Prompt message to display
 * @param {string***REMOVED*** [args.initial] Default string value
 * @param {string***REMOVED*** [args.style="default"] Render style ('default', 'password', 'invisible')
 * @param {function***REMOVED*** [args.onState] On state change callback
 * @param {function***REMOVED*** [args.validate] Function to validate user input
 * @param {Stream***REMOVED*** [args.stdin] The Readable stream to listen to
 * @param {Stream***REMOVED*** [args.stdout] The Writable stream to write readline data to
 * @returns {Promise***REMOVED*** Promise with user input
 */


$.text = args => toPrompt('TextPrompt', args);
/**
 * Password prompt with masked input
 * @param {string***REMOVED*** args.message Prompt message to display
 * @param {string***REMOVED*** [args.initial] Default string value
 * @param {function***REMOVED*** [args.onState] On state change callback
 * @param {function***REMOVED*** [args.validate] Function to validate user input
 * @param {Stream***REMOVED*** [args.stdin] The Readable stream to listen to
 * @param {Stream***REMOVED*** [args.stdout] The Writable stream to write readline data to
 * @returns {Promise***REMOVED*** Promise with user input
 */


$.password = args => {
  args.style = 'password';
  return $.text(args);
***REMOVED***;
/**
 * Prompt where input is invisible, like sudo
 * @param {string***REMOVED*** args.message Prompt message to display
 * @param {string***REMOVED*** [args.initial] Default string value
 * @param {function***REMOVED*** [args.onState] On state change callback
 * @param {function***REMOVED*** [args.validate] Function to validate user input
 * @param {Stream***REMOVED*** [args.stdin] The Readable stream to listen to
 * @param {Stream***REMOVED*** [args.stdout] The Writable stream to write readline data to
 * @returns {Promise***REMOVED*** Promise with user input
 */


$.invisible = args => {
  args.style = 'invisible';
  return $.text(args);
***REMOVED***;
/**
 * Number prompt
 * @param {string***REMOVED*** args.message Prompt message to display
 * @param {number***REMOVED*** args.initial Default number value
 * @param {function***REMOVED*** [args.onState] On state change callback
 * @param {number***REMOVED*** [args.max] Max value
 * @param {number***REMOVED*** [args.min] Min value
 * @param {string***REMOVED*** [args.style="default"] Render style ('default', 'password', 'invisible')
 * @param {Boolean***REMOVED*** [opts.float=false] Parse input as floats
 * @param {Number***REMOVED*** [opts.round=2] Round floats to x decimals
 * @param {Number***REMOVED*** [opts.increment=1] Number to increment by when using arrow-keys
 * @param {function***REMOVED*** [args.validate] Function to validate user input
 * @param {Stream***REMOVED*** [args.stdin] The Readable stream to listen to
 * @param {Stream***REMOVED*** [args.stdout] The Writable stream to write readline data to
 * @returns {Promise***REMOVED*** Promise with user input
 */


$.number = args => toPrompt('NumberPrompt', args);
/**
 * Date prompt
 * @param {string***REMOVED*** args.message Prompt message to display
 * @param {number***REMOVED*** args.initial Default number value
 * @param {function***REMOVED*** [args.onState] On state change callback
 * @param {number***REMOVED*** [args.max] Max value
 * @param {number***REMOVED*** [args.min] Min value
 * @param {string***REMOVED*** [args.style="default"] Render style ('default', 'password', 'invisible')
 * @param {Boolean***REMOVED*** [opts.float=false] Parse input as floats
 * @param {Number***REMOVED*** [opts.round=2] Round floats to x decimals
 * @param {Number***REMOVED*** [opts.increment=1] Number to increment by when using arrow-keys
 * @param {function***REMOVED*** [args.validate] Function to validate user input
 * @param {Stream***REMOVED*** [args.stdin] The Readable stream to listen to
 * @param {Stream***REMOVED*** [args.stdout] The Writable stream to write readline data to
 * @returns {Promise***REMOVED*** Promise with user input
 */


$.date = args => toPrompt('DatePrompt', args);
/**
 * Classic yes/no prompt
 * @param {string***REMOVED*** args.message Prompt message to display
 * @param {boolean***REMOVED*** [args.initial=false] Default value
 * @param {function***REMOVED*** [args.onState] On state change callback
 * @param {Stream***REMOVED*** [args.stdin] The Readable stream to listen to
 * @param {Stream***REMOVED*** [args.stdout] The Writable stream to write readline data to
 * @returns {Promise***REMOVED*** Promise with user input
 */


$.confirm = args => toPrompt('ConfirmPrompt', args);
/**
 * List prompt, split intput string by `seperator`
 * @param {string***REMOVED*** args.message Prompt message to display
 * @param {string***REMOVED*** [args.initial] Default string value
 * @param {string***REMOVED*** [args.style="default"] Render style ('default', 'password', 'invisible')
 * @param {string***REMOVED*** [args.separator] String separator
 * @param {function***REMOVED*** [args.onState] On state change callback
 * @param {Stream***REMOVED*** [args.stdin] The Readable stream to listen to
 * @param {Stream***REMOVED*** [args.stdout] The Writable stream to write readline data to
 * @returns {Promise***REMOVED*** Promise with user input, in form of an `Array`
 */


$.list = args => {
  const sep = args.separator || ',';
  return toPrompt('TextPrompt', args, {
    onSubmit: str => str.split(sep).map(s => s.trim())
  ***REMOVED***);
***REMOVED***;
/**
 * Toggle/switch prompt
 * @param {string***REMOVED*** args.message Prompt message to display
 * @param {boolean***REMOVED*** [args.initial=false] Default value
 * @param {string***REMOVED*** [args.active="on"] Text for `active` state
 * @param {string***REMOVED*** [args.inactive="off"] Text for `inactive` state
 * @param {function***REMOVED*** [args.onState] On state change callback
 * @param {Stream***REMOVED*** [args.stdin] The Readable stream to listen to
 * @param {Stream***REMOVED*** [args.stdout] The Writable stream to write readline data to
 * @returns {Promise***REMOVED*** Promise with user input
 */


$.toggle = args => toPrompt('TogglePrompt', args);
/**
 * Interactive select prompt
 * @param {string***REMOVED*** args.message Prompt message to display
 * @param {Array***REMOVED*** args.choices Array of choices objects `[{ title, value ***REMOVED***, ...]`
 * @param {number***REMOVED*** [args.initial] Index of default value
 * @param {String***REMOVED*** [args.hint] Hint to display
 * @param {function***REMOVED*** [args.onState] On state change callback
 * @param {Stream***REMOVED*** [args.stdin] The Readable stream to listen to
 * @param {Stream***REMOVED*** [args.stdout] The Writable stream to write readline data to
 * @returns {Promise***REMOVED*** Promise with user input
 */


$.select = args => toPrompt('SelectPrompt', args);
/**
 * Interactive multi-select / autocompleteMultiselect prompt
 * @param {string***REMOVED*** args.message Prompt message to display
 * @param {Array***REMOVED*** args.choices Array of choices objects `[{ title, value, [selected] ***REMOVED***, ...]`
 * @param {number***REMOVED*** [args.max] Max select
 * @param {string***REMOVED*** [args.hint] Hint to display user
 * @param {Number***REMOVED*** [args.cursor=0] Cursor start position
 * @param {function***REMOVED*** [args.onState] On state change callback
 * @param {Stream***REMOVED*** [args.stdin] The Readable stream to listen to
 * @param {Stream***REMOVED*** [args.stdout] The Writable stream to write readline data to
 * @returns {Promise***REMOVED*** Promise with user input
 */


$.multiselect = args => {
  args.choices = [].concat(args.choices || []);

  const toSelected = items => items.filter(item => item.selected).map(item => item.value);

  return toPrompt('MultiselectPrompt', args, {
    onAbort: toSelected,
    onSubmit: toSelected
  ***REMOVED***);
***REMOVED***;

$.autocompleteMultiselect = args => {
  args.choices = [].concat(args.choices || []);

  const toSelected = items => items.filter(item => item.selected).map(item => item.value);

  return toPrompt('AutocompleteMultiselectPrompt', args, {
    onAbort: toSelected,
    onSubmit: toSelected
  ***REMOVED***);
***REMOVED***;

const byTitle = (input, choices) => Promise.resolve(choices.filter(item => item.title.slice(0, input.length).toLowerCase() === input.toLowerCase()));
/**
 * Interactive auto-complete prompt
 * @param {string***REMOVED*** args.message Prompt message to display
 * @param {Array***REMOVED*** args.choices Array of auto-complete choices objects `[{ title, value ***REMOVED***, ...]`
 * @param {Function***REMOVED*** [args.suggest] Function to filter results based on user input. Defaults to sort by `title`
 * @param {number***REMOVED*** [args.limit=10] Max number of results to show
 * @param {string***REMOVED*** [args.style="default"] Render style ('default', 'password', 'invisible')
 * @param {String***REMOVED*** [args.initial] Index of the default value
 * @param {boolean***REMOVED*** [opts.clearFirst] The first ESCAPE keypress will clear the input
 * @param {String***REMOVED*** [args.fallback] Fallback message - defaults to initial value
 * @param {function***REMOVED*** [args.onState] On state change callback
 * @param {Stream***REMOVED*** [args.stdin] The Readable stream to listen to
 * @param {Stream***REMOVED*** [args.stdout] The Writable stream to write readline data to
 * @returns {Promise***REMOVED*** Promise with user input
 */


$.autocomplete = args => {
  args.suggest = args.suggest || byTitle;
  args.choices = [].concat(args.choices || []);
  return toPrompt('AutocompletePrompt', args);
***REMOVED***;