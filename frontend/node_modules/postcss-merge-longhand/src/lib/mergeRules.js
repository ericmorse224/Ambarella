'use strict';
const hasAllProps = require('./hasAllProps.js');
const getDecls = require('./getDecls.js');
const getRules = require('./getRules.js');

/**
 * @param {import('postcss').Declaration***REMOVED*** propA
 * @param {import('postcss').Declaration***REMOVED*** propB
 * @return {boolean***REMOVED***
 */
function isConflictingProp(propA, propB) {
  if (
    !propB.prop ||
    propB.important !== propA.important ||
    propA.prop === propB.prop
  ) {
    return false;
  ***REMOVED***

  const partsA = propA.prop.split('-');
  const partsB = propB.prop.split('-');

  /* Be safe: check that the first part matches. So we don't try to
   * combine e.g. border-color and color.
   */
  if (partsA[0] !== partsB[0]) {
    return false;
  ***REMOVED***

  const partsASet = new Set(partsA);
  return partsB.every((partB) => partsASet.has(partB));
***REMOVED***

/**
 * @param {import('postcss').Declaration[]***REMOVED*** match
 * @param {import('postcss').Declaration[]***REMOVED*** nodes
 * @return {boolean***REMOVED***
 */
function hasConflicts(match, nodes) {
  const firstNode = Math.min(...match.map((n) => nodes.indexOf(n)));
  const lastNode = Math.max(...match.map((n) => nodes.indexOf(n)));
  const between = nodes.slice(firstNode + 1, lastNode);

  return match.some((a) => between.some((b) => isConflictingProp(a, b)));
***REMOVED***

/**
 * @param {import('postcss').Rule***REMOVED*** rule
 * @param {string[]***REMOVED*** properties
 * @param {(rules: import('postcss').Declaration[], last: import('postcss').Declaration, props: import('postcss').Declaration[]) => boolean***REMOVED*** callback
 * @return {void***REMOVED***
 */
module.exports = function mergeRules(rule, properties, callback) {
  let decls = getDecls(rule, properties);

  while (decls.length) {
    const last = decls[decls.length - 1];
    const props = decls.filter((node) => node.important === last.important);
    const rules = getRules(props, properties);

    if (
      hasAllProps(rules, ...properties) &&
      !hasConflicts(
        rules,
        /** @type import('postcss').Declaration[]*/ (rule.nodes)
      )
    ) {
      if (callback(rules, last, props)) {
        decls = decls.filter((node) => !rules.includes(node));
      ***REMOVED***
    ***REMOVED***

    decls = decls.filter((node) => node !== last);
  ***REMOVED***
***REMOVED***;
